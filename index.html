<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Треки: поиск + админ-сканер (авто дата/время)</title>
<style>
  :root { --gap:12px; --radius:12px; }
  * { box-sizing: border-box; }
  body { margin:0; padding:24px; background:#f6f7fb; color:#222;
    font-family: system-ui,-apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap { max-width: 960px; margin: 0 auto; }
  h1 { margin: 0 0 12px; font-size: 22px; }
  .toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:10px; }
  .card { background:#fff; border-radius:var(--radius); box-shadow:0 8px 28px rgba(0,0,0,.06); padding:18px; }
  label { display:block; font-size:12px; color:#555; margin-bottom:6px; }
  input, button, select { height:42px; border-radius:10px; border:1px solid #dcdfe6; padding:0 12px; font-size:14px; outline:none; background:#fff; }
  input:focus, select:focus { border-color:#6c8dff; box-shadow:0 0 0 3px rgba(108,141,255,.16); }
  button { border:none; background:#2d6cff; color:#fff; font-weight:700; cursor:pointer; padding:0 16px; }
  button.secondary { background:#eef2ff; color:#1f3b8a; border:1px solid #d9e1ff; }
  button.danger { background:#ffecec; color:#8b1a1a; border:1px solid #ffc9c9; }
  .muted { color:#777; font-size:12px; margin-top:8px; }
  .grid { display:grid; grid-template-columns: 2fr auto; gap: var(--gap); }
  .row { display:grid; grid-template-columns: 1fr auto; gap: var(--gap); margin-top:14px; }
  table { width:100%; border-collapse:collapse; margin-top:16px; background:#fff; }
  th, td { padding:10px 12px; border-bottom:1px solid #eee; font-size:14px; }
  th { text-align:left; color:#666; font-weight:600; }
  tr:hover td { background:#fafbff; }
  .narrow { width:150px; }
  .idcell { width:80px; color:#999; }
  .empty { text-align:center; color:#777; padding:18px 12px; }
  .admin-only { display:none; }
  .scanwrap { display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }
  video { width:100%; max-height:300px; background:#000; border-radius:10px; }
  .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; background:#fafafa; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <h1>Список трек-номеров</h1>
      <!-- Кнопка входа в админ -->
      <button id="adminToggle" class="secondary" title="Вход для администратора">Войти как админ</button>
    </div>

    <div class="card">
      <!-- Поиск доступен всем -->
      <label for="q">Поиск по треку</label>
      <input id="q" type="text" placeholder="Начните вводить трек…" autocomplete="off" />

      <!-- Таблица -->
      <table aria-label="Таблица трек-номеров">
        <thead>
          <tr>
            <th class="idcell">#</th>
            <th>Трек-номер</th>
            <th class="narrow">Дата</th>
            <th class="narrow">Время</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr class="empty"><td colspan="4">Пока нет записей</td></tr>
        </tbody>
      </table>

      <div class="muted">Клиенты видят только поиск и таблицу. Добавление доступно только администратору. Дата и время ставятся автоматически.</div>

      <!-- Админ-блок (скрыт по умолчанию) -->
      <div id="adminBlock" class="admin-only">
        <hr style="margin:18px 0;border:none;border-top:1px solid #eee" />
        <span class="pill" id="scanStatus">Сканер: выключен</span>

        <!-- Ручное добавление (без даты/времени — они проставляются автоматически) -->
        <div class="grid" style="margin-top:12px;">
          <div>
            <label for="track">Трек-номер</label>
            <input id="track" type="text" placeholder="LC859123456CN" minlength="3" maxlength="64" pattern="^[A-Za-z0-9._-]+$" />
          </div>
          <div style="align-self:end;">
            <button id="addBtn">Добавить</button>
          </div>
        </div>

        <!-- Камера -->
        <div class="scanwrap">
          <div class="row">
            <div>
              <label for="cameraSelect">Камера</label>
              <select id="cameraSelect"></select>
            </div>
            <div style="display:flex; gap:10px; align-items:end;">
              <button id="startScan">Включить сканер</button>
              <button id="stopScan" class="danger">Выключить</button>
            </div>
          </div>
          <video id="preview" playsinline muted></video>
          <div class="muted">
            Наведите камеру на штрих-код/QR. Если сканер недоступен в браузере — введите трек вручную. Дата/время заполняются автоматически.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================== ХРАНИЛИЩЕ (localStorage) ================== */
const KEY = 'tracks-shared-v2';
/** @returns {Array<{id:number,track:string,date:string,time:string}>} */
function load() { try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch { return []; } }
function save(list) { localStorage.setItem(KEY, JSON.stringify(list)); }

/* ================== ЭЛЕМЕНТЫ UI ================== */
const $q = document.getElementById('q');
const $tbody = document.getElementById('tbody');
const $adminToggle = document.getElementById('adminToggle');
const $adminBlock = document.getElementById('adminBlock');
const $track = document.getElementById('track');
const $add   = document.getElementById('addBtn');
const $cameraSelect = document.getElementById('cameraSelect');
const $startScan = document.getElementById('startScan');
const $stopScan = document.getElementById('stopScan');
const $preview = document.getElementById('preview');
const $scanStatus = document.getElementById('scanStatus');

let rows = load();
let nextId = rows.reduce((m, r) => Math.max(m, r.id), 0) + 1;
let query = '';

/* ================== ВСПОМОГАТЕЛЬНОЕ ================== */
function nowDate()  { return new Date().toISOString().slice(0,10); }           // YYYY-MM-DD
function nowTime()  { return new Date().toTimeString().slice(0,5); }            // HH:MM
function isValidTrack(t){ return /^[A-Za-z0-9._-]{3,64}$/.test(t); }

/* ================== РЕНДЕР ================== */
function render() {
  $tbody.innerHTML = '';
  const list = rows
    .filter(r => r.track.toLowerCase().includes(query))
    .sort((a,b) => b.id - a.id);

  if (!list.length) {
    const tr = document.createElement('tr');
    tr.className = 'empty';
    tr.innerHTML = '<td colspan="4">Нет записей по фильтру</td>';
    $tbody.appendChild(tr);
    return;
  }

  list.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idcell">${list.length - idx}</td>
      <td>${r.track}</td>
      <td class="narrow">${r.date}</td>
      <td class="narrow">${r.time}</td>
    `;
    $tbody.appendChild(tr);
  });
}

/* ================== ДОБАВЛЕНИЕ (только админ) ================== */
function add(track) {
  const t = (track || '').trim();
  if (!isValidTrack(t)) { alert('Трек: буквы/цифры/._- (3–64).'); return; }

  // Не добавляем дубликаты
  if (rows.some(x => x.track === t)) { alert('Такой трек уже есть.'); return; }

  rows.push({ id: nextId++, track: t, date: nowDate(), time: nowTime() });
  save(rows);
  render();
}

$add.addEventListener('click', () => {
  add($track.value);
  $track.value = '';
  $track.focus();
});

$track.addEventListener('keydown', e => { if (e.key === 'Enter') { $add.click(); } });

/* ================== ПОИСК (доступен всем) ================== */
$q.addEventListener('input', () => {
  query = ($q.value || '').trim().toLowerCase();
  render();
});

/* ================== АДМИН-РЕЖИМ ================== */
/* ВНИМАНИЕ: это простой фронтовый пароль. Для настоящей защиты нужен сервер. */
function promptAdmin() {
  const pass = prompt('Введите пароль администратора:');
  // Замените условие на ваш пароль, например 'LC859'
  if (pass === 'LC859') {
    $adminBlock.style.display = 'block';
    $adminToggle.textContent = 'Админ включен';
    $adminToggle.disabled = true;
  } else if (pass !== null) {
    alert('Неверный пароль.');
  }
}
$adminToggle.addEventListener('click', promptAdmin);

/* ================== СКАНЕР ШТРИХ-КОДОВ ================== */
let stream = null;
let detector = null;
let scanTimer = null;

async function listCameras() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    $cameraSelect.innerHTML = '';
    cams.forEach((d, i) => {
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `Камера ${i+1}`;
      $cameraSelect.appendChild(opt);
    });
  } catch (e) { console.warn('enumerateDevices error:', e); }
}

async function startCamera(deviceId) {
  if (stream) stopCamera();
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' },
      audio: false
    });
    $preview.srcObject = stream;
    await $preview.play();
  } catch (e) {
    alert('Не удалось включить камеру: ' + e.message);
  }
}

function stopCamera() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  $preview.pause(); $preview.srcObject = null;
}

async function initDetector() {
  if ('BarcodeDetector' in window) {
    try {
      const formats = await BarcodeDetector.getSupportedFormats();
      detector = new BarcodeDetector({ formats });
      return true;
    } catch (e) { console.warn('BarcodeDetector init error:', e); }
  }
  detector = null; return false;
}

async function scanOnce() {
  if (!detector || !stream) return;
  try {
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const bitmap = await imageCapture.grabFrame();
    const codes = await detector.detect(bitmap);
    if (codes && codes.length) {
      const raw = (codes[0].rawValue || '').trim();
      if (raw) {
        add(raw); // дата/время проставятся автоматически
        $scanStatus.textContent = 'Сканер: найдено ' + raw;
        clearInterval(scanTimer);
        setTimeout(() => { $scanStatus.textContent = 'Сканер: включен'; startScanLoop(); }, 1200);
      }
    }
  } catch (e) { /* тихо */ }
}

function startScanLoop() {
  if (scanTimer) clearInterval(scanTimer);
  scanTimer = setInterval(scanOnce, 500);
}

$startScan.addEventListener('click', async () => {
  await listCameras();
  const ok = await initDetector();
  if (!ok) { alert('Сканер не поддерживается этим браузером. Введите трек вручную.'); return; }
  await startCamera($cameraSelect.value);
  $scanStatus.textContent = 'Сканер: включен';
  startScanLoop();
});

$stopScan.addEventListener('click', () => {
  if (scanTimer) clearInterval(scanTimer);
  scanTimer = null;
  stopCamera();
  $scanStatus.textContent = 'Сканер: выключен';
});

/* ================== ПЕРВЫЙ РЕНДЕР ================== */
render();
</script>
</body>
</html>
