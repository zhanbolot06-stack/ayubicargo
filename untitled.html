<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Трек-номера</title>
<style>
  :root { --gap:12px; --radius:12px; }
  * { box-sizing: border-box; }
  body { margin:0; padding:24px; background:#f6f7fb; color:#222;
    font-family: system-ui,-apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap { max-width: 960px; margin: 0 auto; }
  h1 { margin: 0 0 12px; font-size: 22px; }
  .card { background:#fff; border-radius:var(--radius); box-shadow:0 8px 28px rgba(0,0,0,.06); padding:18px; }
  label { display:block; font-size:12px; color:#555; margin-bottom:6px; }
  input, button, select {
    height:42px; border-radius:10px; border:1px solid #dcdfe6; padding:0 12px; font-size:14px; outline:none; background:#fff;
  }
  input:focus, select:focus { border-color:#6c8dff; box-shadow:0 0 0 3px rgba(108,141,255,.16); }
  button { border:none; background:#2d6cff; color:#fff; font-weight:700; cursor:pointer; padding:0 16px; }
  button.secondary { background:#eef2ff; color:#1f3b8a; border:1px solid #d9e1ff; }
  button.danger { background:#ffecec; color:#8b1a1a; border:1px solid #ffc9c9; }
  table { width:100%; border-collapse:collapse; margin-top:16px; background:#fff; }
  th, td { padding:10px 12px; border-bottom:1px solid #eee; font-size:14px; }
  th { text-align:left; color:#666; font-weight:600; }
  tr:hover td { background:#fafbff; }
  .narrow { width:150px; }
  .idcell { width:80px; color:#999; }
  .empty { text-align:center; color:#777; padding:18px 12px; }
  .toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:10px; }
  .muted { color:#777; font-size:12px; margin-top:8px; }
  .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; background:#fafafa; }
  .grid { display:grid; grid-template-columns: 2fr auto; gap: var(--gap); }
  .row { display:grid; grid-template-columns: 1fr auto; gap: var(--gap); margin-top:14px; }
  video { width:100%; max-height:320px; background:#000; border-radius:10px; }
  .hidden { display:none !important; }
  .link { text-decoration: none; font-weight: 700; }
</style>
</head>
<body>
  <div class="wrap">
    <!-- === КЛИЕНТСКАЯ СТРАНИЦА === -->
    <section id="clientPage" class="hidden">
      <div class="toolbar">
        <h1>Список трек-номеров</h1>
        <!-- Подсказка для вас: отдельная ссылка на админку -->
        <a class="link" href="#/admin" style="color:#6c8dff">Админ-страница</a>
      </div>

      <div class="card">
        <label for="q">Поиск по треку</label>
        <input id="q" type="text" placeholder="Начните вводить трек…" autocomplete="off" />

        <table aria-label="Таблица трек-номеров">
          <thead>
            <tr>
              <th class="idcell">#</th>
              <th>Трек-номер</th>
              <th class="narrow">Дата</th>
              <th class="narrow">Время</th>
            </tr>
          </thead>
          <tbody id="tbodyClient">
            <tr class="empty"><td colspan="4">Пока нет записей</td></tr>
          </tbody>
        </table>

        <div class="muted">
          Клиенты видят только поиск и таблицу. Дата и время проставлены автоматически при добавлении админом.
        </div>
      </div>
    </section>

    <!-- === АДМИН-СТРАНИЦА === -->
    <section id="adminPage" class="hidden">
      <div class="toolbar">
        <h1>Админ: добавить трек</h1>
        <a class="link" href="#/" style="color:#6c8dff">На сайт для клиентов</a>
      </div>

      <div class="card" id="adminAuthCard">
        <p><b>Вход для администратора</b></p>
        <div class="grid">
          <input id="adminPass" type="password" placeholder="Пароль администратора" />
          <button id="adminLoginBtn">Войти</button>
        </div>
        <div class="muted">Пароль хранится в коде страницы (подходит для простого использования). Для настоящей безопасности нужен сервер.</div>
      </div>

      <div class="card hidden" id="adminWorkCard">
        <span class="pill" id="scanStatus">Сканер: выключен</span>
        <div class="grid" style="margin-top:12px;">
          <div>
            <label for="track">Трек-номер</label>
            <input id="track" type="text" placeholder="LC859123456CN" minlength="3" maxlength="64" pattern="^[A-Za-z0-9._-]+$" />
          </div>
          <div style="align-self:end;">
            <button id="addBtn">Добавить</button>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="cameraSelect">Камера</label>
            <select id="cameraSelect"></select>
          </div>
          <div style="display:flex; gap:10px; align-items:end;">
            <button id="startScan">Включить сканер</button>
            <button id="stopScan" class="danger">Выключить</button>
          </div>
        </div>
        <video id="preview" playsinline muted></video>
        <div class="muted">
          Наведите камеру на штрих-код/QR. Если сканер не поддерживается — вводите вручную.
          Дата и время сохраняются автоматически.
        </div>
      </div>
    </section>
  </div>

<script>
/* ================== НАСТРОЙКИ ================== */
// Задайте свой пароль ниже:
const ADMIN_PASSWORD = 'LC859';

/* ================== ХРАНЕНИЕ (localStorage) ================== */
const KEY = 'tracks-v3';
/** @returns {Array<{id:number,track:string,date:string,time:string}>} */
function load() { try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch { return []; } }
function save(list) { localStorage.setItem(KEY, JSON.stringify(list)); }

/* ================== ЭЛЕМЕНТЫ ================== */
const clientPage = document.getElementById('clientPage');
const adminPage  = document.getElementById('adminPage');

const q = document.getElementById('q');
const tbodyClient = document.getElementById('tbodyClient');

const adminAuthCard = document.getElementById('adminAuthCard');
const adminWorkCard = document.getElementById('adminWorkCard');
const adminPass = document.getElementById('adminPass');
const adminLoginBtn = document.getElementById('adminLoginBtn');

const trackInput = document.getElementById('track');
const addBtn = document.getElementById('addBtn');

const cameraSelect = document.getElementById('cameraSelect');
const startScanBtn = document.getElementById('startScan');
const stopScanBtn  = document.getElementById('stopScan');
const preview = document.getElementById('preview');
const scanStatus = document.getElementById('scanStatus');

/* ================== СОСТОЯНИЕ ================== */
let rows = load();
let nextId = rows.reduce((m, r) => Math.max(m, r.id), 0) + 1;
let query = '';

/* ================== УТИЛИТЫ ================== */
const nowDate = () => new Date().toISOString().slice(0,10);
const nowTime = () => new Date().toTimeString().slice(0,5);
const isValidTrack = s => /^[A-Za-z0-9._-]{3,64}$/.test(s || '');

/* ================== РЕНДЕР КЛИЕНТСКОЙ ТАБЛИЦЫ ================== */
function renderClient() {
  tbodyClient.innerHTML = '';
  const list = rows
    .filter(r => r.track.toLowerCase().includes(query))
    .sort((a,b) => b.id - a.id);

  if (!list.length) {
    const tr = document.createElement('tr');
    tr.className = 'empty';
    tr.innerHTML = '<td colspan="4">Нет записей по фильтру</td>';
    tbodyClient.appendChild(tr);
    return;
  }

  list.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idcell">${list.length - idx}</td>
      <td>${r.track}</td>
      <td class="narrow">${r.date}</td>
      <td class="narrow">${r.time}</td>
    `;
    tbodyClient.appendChild(tr);
  });
}

/* ================== ДОБАВЛЕНИЕ (АДМИН) ================== */
function addTrack(t) {
  const val = (t || '').trim();
  if (!isValidTrack(val)) return alert('Трек: буквы/цифры/._- (3–64).');
  if (rows.some(x => x.track === val)) return alert('Такой трек уже есть.');

  rows.push({ id: nextId++, track: val, date: nowDate(), time: nowTime() });
  save(rows);
  renderClient();
}

addBtn.addEventListener('click', () => {
  addTrack(trackInput.value);
  trackInput.value = '';
  trackInput.focus();
});
trackInput.addEventListener('keydown', e => { if (e.key === 'Enter') addBtn.click(); });

/* ================== ПОИСК (КЛИЕНТ) ================== */
q && q.addEventListener('input', () => {
  query = (q.value || '').trim().toLowerCase();
  renderClient();
});

/* ================== ПРОСТОЙ РОУТИНГ (#/ , #/admin) ================== */
function route() {
  const hash = location.hash.replace('#','');
  const isAdmin = (hash === '/admin');

  clientPage.classList.toggle('hidden',  isAdmin);
  adminPage.classList.toggle('hidden',  !isAdmin);

  if (!isAdmin) {
    // клиентская
    renderClient();
  } else {
    // админская — показываем форму входа
    adminAuthCard.classList.remove('hidden');
    adminWorkCard.classList.add('hidden');
    adminPass.value = '';
    stopCamera();
  }
}
window.addEventListener('hashchange', route);
route(); // первый запуск

/* ================== АВТОРИЗАЦИЯ АДМИНА ================== */
adminLoginBtn.addEventListener('click', () => {
  if (adminPass.value === ADMIN_PASSWORD) {
    adminAuthCard.classList.add('hidden');
    adminWorkCard.classList.remove('hidden');
    trackInput.focus();
  } else {
    alert('Неверный пароль.');
  }
});
adminPass.addEventListener('keydown', e => { if (e.key === 'Enter') adminLoginBtn.click(); });

/* ================== СКАНЕР ШТРИХ-КОДОВ (АДМИН) ================== */
let stream = null;
let detector = null;
let scanTimer = null;

async function listCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d => d.kind === 'videoinput');
  cameraSelect.innerHTML = '';
  cams.forEach((d, i) => {
    const opt = document.createElement('option');
    opt.value = d.deviceId;
    opt.textContent = d.label || `Камера ${i+1}`;
    cameraSelect.appendChild(opt);
  });
}

async function startCamera(deviceId) {
  if (stream) stopCamera();
  stream = await navigator.mediaDevices.getUserMedia({
    video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' },
    audio: false
  });
  preview.srcObject = stream;
  await preview.play();
}

function stopCamera() {
  if (scanTimer) { clearInterval(scanTimer); scanTimer = null; }
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  preview.pause();
  preview.srcObject = null;
  scanStatus.textContent = 'Сканер: выключен';
}

async function initDetector() {
  if (!('BarcodeDetector' in window)) return null;
  try {
    const formats = await BarcodeDetector.getSupportedFormats();
    return new BarcodeDetector({ formats });
  } catch { return null; }
}

async function scanOnce() {
  if (!detector || !stream) return;
  try {
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const bitmap = await imageCapture.grabFrame();
    const codes = await detector.detect(bitmap);
    if (codes && codes.length) {
      const raw = (codes[0].rawValue || '').trim();
      if (raw) {
        addTrack(raw); // дата/время автоматически
        scanStatus.textContent = 'Сканер: найдено ' + raw;
        clearInterval(scanTimer);
        setTimeout(() => { scanStatus.textContent = 'Сканер: включен'; startScanLoop(); }, 1200);
      }
    }
  } catch { /* игнор */ }
}

function startScanLoop() {
  if (scanTimer) clearInterval(scanTimer);
  scanTimer = setInterval(scanOnce, 500);
}

startScanBtn.addEventListener('click', async () => {
  await listCameras();
  detector = await initDetector();
  if (!detector) { alert('Сканер не поддерживается этим браузером. Введите трек вручную.'); return; }
  await startCamera(cameraSelect.value);
  scanStatus.textContent = 'Сканер: включен';
  startScanLoop();
});

stopScanBtn.addEventListener('click', stopCamera);

/* ================== ПЕРВЫЙ РЕНДЕР ================== */
renderClient();
</script>
</body>
</html>
