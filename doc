<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Трек-номера</title>
<style>
  :root { --gap:12px; --radius:12px; }
  * { box-sizing: border-box; }
  body { margin:0; padding:24px; background:#f6f7fb; color:#222;
    font-family: system-ui,-apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap { max-width: 980px; margin: 0 auto; }
  h1 { margin: 0 0 12px; font-size: 22px; }
  .card { background:#fff; border-radius:var(--radius); box-shadow:0 8px 28px rgba(0,0,0,.06); padding:18px; }
  label { display:block; font-size:12px; color:#555; margin-bottom:6px; }
  input, button, select {
    height:42px; border-radius:10px; border:1px solid #dcdfe6; padding:0 12px; font-size:14px; outline:none; background:#fff;
  }
  input:focus, select:focus { border-color:#6c8dff; box-shadow:0 0 0 3px rgba(108,141,255,.16); }
  button { border:none; background:#2d6cff; color:#fff; font-weight:700; cursor:pointer; padding:0 16px; }
  button.secondary { background:#eef2ff; color:#1f3b8a; border:1px solid #d9e1ff; }
  button.danger { background:#ffecec; color:#8b1a1a; border:1px solid #ffc9c9; }
  table { width:100%; border-collapse:collapse; margin-top:16px; background:#fff; }
  th, td { padding:10px 12px; border-bottom:1px solid #eee; font-size:14px; }
  th { text-align:left; color:#666; font-weight:600; }
  tr:hover td { background:#fafbff; }
  .narrow { width:150px; }
  .idcell { width:70px; color:#999; }
  .empty { text-align:center; color:#777; padding:18px 12px; }
  .toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:10px; }
  .muted { color:#777; font-size:12px; margin-top:8px; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: var(--gap); }
  .gridA { display:grid; grid-template-columns: 2fr 1fr; gap: var(--gap); }
  .row { display:grid; grid-template-columns: 1fr auto; gap: var(--gap); margin-top:14px; }
  video { width:100%; max-height:320px; background:#000; border-radius:10px; }
  .hidden { display:none !important; }
  .link { text-decoration: none; font-weight: 700; color:#6c8dff; }
  .status-badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; background:#f9fafb; }
</style>
</head>
<body>
  <div class="wrap">
    <!-- === КЛИЕНТСКАЯ СТРАНИЦА === -->
    <section id="clientPage" class="hidden">
      <div class="toolbar">
        <h1>Список трек-номеров</h1>
        <a class="link" href="#/admin">Админ-страница</a>
      </div>

      <div class="card">
        <div class="grid2">
          <div>
            <label for="q">Поиск по треку</label>
            <input id="q" type="text" placeholder="Начните вводить трек…" autocomplete="off" />
          </div>
          <div>
            <label for="dateFrom">Дата с</label>
            <input id="dateFrom" type="date" />
          </div>
          <div>
            <label for="dateTo">Дата по</label>
            <input id="dateTo" type="date" />
          </div>
          <div>
            <label for="statusFilter">Статус</label>
            <select id="statusFilter">
              <option value="">Все</option>
              <option>Новый</option>
              <option>Отправлен</option>
              <option>В пути</option>
              <option>Прибыл</option>
              <option>Выдан</option>
            </select>
          </div>
          <div style="align-self:end">
            <button id="resetFilters" class="secondary">Сбросить</button>
          </div>
        </div>

        <table aria-label="Таблица трек-номеров">
          <thead>
            <tr>
              <th class="idcell">#</th>
              <th>Трек-номер</th>
              <th class="narrow">Дата</th>
              <th class="narrow">Время</th>
              <th class="narrow">Статус</th>
            </tr>
          </thead>
          <tbody id="tbodyClient">
            <tr class="empty"><td colspan="5">Пока нет записей</td></tr>
          </tbody>
        </table>

        <div class="muted" id="countBox">—</div>
      </div>
    </section>

    <!-- === АДМИН-СТРАНИЦА === -->
    <section id="adminPage" class="hidden">
      <div class="toolbar">
        <h1>Админ: добавить трек</h1>
        <a class="link" href="#/">На сайт для клиентов</a>
      </div>

      <div class="card" id="adminAuthCard">
        <div class="gridA">
          <input id="adminPass" type="password" placeholder="Пароль администратора" />
          <button id="adminLoginBtn">Войти</button>
        </div>
        <div class="muted">Дата и время проставляются автоматически. Для реальной защиты лучше сервер.</div>
      </div>

      <div class="card hidden" id="adminWorkCard">
        <div class="grid2">
          <div>
            <label for="track">Трек-номер</label>
            <input id="track" type="text" placeholder="LC859123456CN" minlength="3" maxlength="64" pattern="^[A-Za-z0-9._-]+$" />
          </div>
          <div>
            <label for="statusInput">Статус</label>
            <select id="statusInput">
              <option>Новый</option>
              <option selected>Отправлен</option>
              <option>В пути</option>
              <option>Прибыл</option>
              <option>Выдан</option>
            </select>
          </div>
          <div style="align-self:end">
            <button id="addBtn">Добавить</button>
          </div>
          <div style="grid-column: 1 / -1"><span id="scanStatus" class="status-badge">Сканер: выключен</span></div>
        </div>

        <div class="row">
          <div>
            <label for="cameraSelect">Камера</label>
            <select id="cameraSelect"></select>
          </div>
          <div style="display:flex; gap:10px; align-items:end;">
            <button id="startScan">Включить сканер</button>
            <button id="stopScan" class="danger">Выключить</button>
          </div>
        </div>
        <video id="preview" playsinline muted></video>
      </div>
    </section>
  </div>

<script>
/* =============== НАСТРОЙКИ =============== */
const ADMIN_PASSWORD = 'LC859'; // замените на свой

/* =============== ХРАНЕНИЕ =============== */
const KEY = 'tracks-v4';
/** @returns {Array<{id:number,track:string,date:string,time:string,status:string}>} */
function load() { try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch { return []; } }
function save(list) { localStorage.setItem(KEY, JSON.stringify(list)); }

/* =============== ЭЛЕМЕНТЫ =============== */
const clientPage = document.getElementById('clientPage');
const adminPage  = document.getElementById('adminPage');

const q = document.getElementById('q');
const dateFrom = document.getElementById('dateFrom');
const dateTo   = document.getElementById('dateTo');
const statusFilter = document.getElementById('statusFilter');
const resetFilters = document.getElementById('resetFilters');
const tbodyClient = document.getElementById('tbodyClient');
const countBox = document.getElementById('countBox');

const adminAuthCard = document.getElementById('adminAuthCard');
const adminWorkCard = document.getElementById('adminWorkCard');
const adminPass = document.getElementById('adminPass');
const adminLoginBtn = document.getElementById('adminLoginBtn');

const trackInput = document.getElementById('track');
const statusInput = document.getElementById('statusInput');
const addBtn = document.getElementById('addBtn');

const cameraSelect = document.getElementById('cameraSelect');
const startScanBtn = document.getElementById('startScan');
const stopScanBtn  = document.getElementById('stopScan');
const preview = document.getElementById('preview');
const scanStatus = document.getElementById('scanStatus');

/* =============== СОСТОЯНИЕ =============== */
let rows = load();
let nextId = rows.reduce((m, r) => Math.max(m, r.id), 0) + 1;

/* =============== УТИЛИТЫ =============== */
const nowDate = () => new Date().toISOString().slice(0,10);
const nowTime = () => new Date().toTimeString().slice(0,5);
const isValidTrack = s => /^[A-Za-z0-9._-]{3,64}$/.test(s || '');
const inRange = (d, from, to) => (!from || d >= from) && (!to || d <= to);

/* =============== РЕНДЕР (КЛИЕНТ) =============== */
function renderClient() {
  const query = (q.value || '').trim().toLowerCase();
  const f = dateFrom.value || '';
  const t = dateTo.value   || '';
  const st = statusFilter.value || '';

  const list = rows
    .filter(r =>
      r.track.toLowerCase().includes(query) &&
      inRange(r.date, f, t) &&
      (st ? r.status === st : true)
    )
    .sort((a,b) => b.id - a.id);

  tbodyClient.innerHTML = '';
  if (!list.length) {
    const tr = document.createElement('tr');
    tr.className = 'empty';
    tr.innerHTML = '<td colspan="5">Нет записей по фильтру</td>';
    tbodyClient.appendChild(tr);
    countBox.textContent = 'Ничего не найдено.';
    return;
  }

  list.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="idcell">${list.length - idx}</td>
      <td>${r.track}</td>
      <td class="narrow">${r.date}</td>
      <td class="narrow">${r.time}</td>
      <td class="narrow"><span class="status-badge">${r.status}</span></td>
    `;
    tbodyClient.appendChild(tr);
  });

  countBox.textContent = `Показано: ${list.length} из ${rows.length}`;
}

/* =============== ДОБАВЛЕНИЕ (АДМИН) =============== */
function addTrack(t, statusVal) {
  const val = (t || '').trim();
  if (!isValidTrack(val)) return alert('Трек: буквы/цифры/._- (3–64).');
  if (rows.some(x => x.track === val)) return alert('Такой трек уже есть.');

  rows.push({ id: nextId++, track: val, date: nowDate(), time: nowTime(), status: statusVal || 'Отправлен' });
  save(rows);
  renderClient();
}

addBtn.addEventListener('click', () => {
  addTrack(trackInput.value, statusInput.value);
  trackInput.value = '';
  trackInput.focus();
});
trackInput.addEventListener('keydown', e => { if (e.key === 'Enter') addBtn.click(); });

/* =============== ФИЛЬТРЫ (КЛИЕНТ) =============== */
[q, dateFrom, dateTo, statusFilter].forEach(el => el.addEventListener('input', renderClient));
resetFilters.addEventListener('click', () => {
  q.value = ''; dateFrom.value = ''; dateTo.value = ''; statusFilter.value = '';
  renderClient();
});

/* =============== РОУТИНГ (#/ , #/admin) =============== */
function route() {
  const isAdmin = (location.hash.replace('#','') === '/admin');
  clientPage.classList.toggle('hidden',  isAdmin);
  adminPage.classList.toggle('hidden',  !isAdmin);
  if (!isAdmin) {
    renderClient();
  } else {
    adminAuthCard.classList.remove('hidden');
    adminWorkCard.classList.add('hidden');
    adminPass.value = '';
    stopCamera();
  }
}
window.addEventListener('hashchange', route);
route();

/* =============== ВХОД АДМИНА =============== */
adminLoginBtn.addEventListener('click', () => {
  if (adminPass.value === ADMIN_PASSWORD) {
    adminAuthCard.classList.add('hidden');
    adminWorkCard.classList.remove('hidden');
    trackInput.focus();
  } else {
    alert('Неверный пароль.');
  }
});
adminPass.addEventListener('keydown', e => { if (e.key === 'Enter') adminLoginBtn.click(); });

/* =============== СКАНЕР (АДМИН) =============== */
let stream = null, detector = null, scanTimer = null;

async function listCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d => d.kind === 'videoinput');
  cameraSelect.innerHTML = '';
  cams.forEach((d, i) => {
    const opt = document.createElement('option');
    opt.value = d.deviceId;
    opt.textContent = d.label || `Камера ${i+1}`;
    cameraSelect.appendChild(opt);
  });
}

async function startCamera(deviceId) {
  if (stream) stopCamera();
  stream = await navigator.mediaDevices.getUserMedia({
    video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' },
    audio: false
  });
  preview.srcObject = stream;
  await preview.play();
}

function stopCamera() {
  if (scanTimer) { clearInterval(scanTimer); scanTimer = null; }
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  preview.pause(); preview.srcObject = null;
  scanStatus.textContent = 'Сканер: выключен';
}

async function initDetector() {
  if (!('BarcodeDetector' in window)) return null;
  try {
    const formats = await BarcodeDetector.getSupportedFormats();
    return new BarcodeDetector({ formats });
  } catch { return null; }
}

async function scanOnce() {
  if (!detector || !stream) return;
  try {
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const bitmap = await imageCapture.grabFrame();
    const codes = await detector.detect(bitmap);
    if (codes && codes.length) {
      const raw = (codes[0].rawValue || '').trim();
      if (raw) {
        addTrack(raw, statusInput.value); // дата/время автоматически
        scanStatus.textContent = 'Сканер: найдено ' + raw;
        clearInterval(scanTimer);
        setTimeout(() => { scanStatus.textContent = 'Сканер: включен'; startScanLoop(); }, 1200);
      }
    }
  } catch { /* игнор */ }
}

function startScanLoop() {
  if (scanTimer) clearInterval(scanTimer);
  scanTimer = setInterval(scanOnce, 500);
}

startScanBtn.addEventListener('click', async () => {
  await listCameras();
  detector = await initDetector();
  if (!detector) { alert('Сканер не поддерживается этим браузером. Введите трек вручную.'); return; }
  await startCamera(cameraSelect.value);
  scanStatus.textContent = 'Сканер: включен';
  startScanLoop();
});
stopScanBtn.addEventListener('click', stopCamera);

/* =============== ПЕРВЫЙ РЕНДЕР =============== */
renderClient();
</script>
</body>
</html>
